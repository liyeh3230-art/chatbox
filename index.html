<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WooTalk - éšæœºåŒ¿åèŠå¤©</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            display: inline-block;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #94a3b8;
            margin: 0 2px;
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    
    <!-- æ¬¢è¿é¡µé¢ -->
    <div id="welcomePage" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold gradient-text mb-3">ğŸ’¬ WooTalk</h1>
                <p class="text-gray-600 text-lg">ä¸é™Œç”ŸäººéšæœºèŠå¤©</p>
            </div>
            
            <div class="space-y-3 mb-6 bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg">
                <div class="flex items-center space-x-2 text-sm text-gray-700">
                    <span class="text-xl">ğŸ­</span>
                    <span><strong>å®Œå…¨åŒ¿å</strong> - æ— éœ€æ³¨å†Œç™»å½•</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-700">
                    <span class="text-xl">ğŸ²</span>
                    <span><strong>éšæœºé…å¯¹</strong> - ä¸€å¯¹ä¸€ç§å¯†èŠå¤©</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-700">
                    <span class="text-xl">âš¡</span>
                    <span><strong>å¿«é€Ÿåˆ‡æ¢</strong> - ä¸å–œæ¬¢å°±ä¸‹ä¸€ä½</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-700">
                    <span class="text-xl">ğŸ›¡ï¸</span>
                    <span><strong>å®‰å…¨ä¿æŠ¤</strong> - é˜²æœºå™¨äººæœºåˆ¶</span>
                </div>
            </div>

            <!-- é˜²æœºå™¨äººéªŒè¯ -->
            <div id="verification" class="mb-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
                <p class="text-sm text-gray-700 mb-3 font-semibold">ğŸ¤– è¯·å®ŒæˆéªŒè¯ï¼š</p>
                <div class="flex items-center space-x-2">
                    <span id="mathQuestion" class="text-xl font-bold text-gray-800"></span>
                    <input 
                        type="number" 
                        id="mathAnswer" 
                        class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 focus:outline-none text-lg"
                        placeholder="ç­”æ¡ˆ">
                </div>
                <p id="verifyError" class="text-red-500 text-sm mt-2 hidden">âŒ éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•</p>
            </div>

            <button 
                onclick="startMatching()"
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 transform hover:scale-105 shadow-lg text-lg">
                ğŸš€ å¼€å§‹é…å¯¹
            </button>
            
            <p class="text-center text-xs text-gray-500 mt-4">
                ç‚¹å‡»å¼€å§‹å³è¡¨ç¤ºæ‚¨åŒæ„éµå®ˆèŠå¤©è§„åˆ™
            </p>
        </div>
    </div>

    <!-- ç­‰å¾…é…å¯¹é¡µé¢ -->
    <div id="matchingPage" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full text-center">
            <div class="mb-8">
                <div class="inline-block relative">
                    <div class="w-24 h-24 border-8 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl">
                        ğŸ”
                    </div>
                </div>
            </div>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-3">æ­£åœ¨å¯»æ‰¾å¯¹è¯å¯¹è±¡...</h2>
            <p class="text-gray-600 mb-6">è¯·ç¨å€™ï¼Œæ­£åœ¨ä¸ºæ‚¨éšæœºé…å¯¹é™Œç”Ÿäºº</p>
            
            <div class="flex items-center justify-center space-x-1 mb-6">
                <span class="pulse-dot w-3 h-3 bg-purple-600 rounded-full"></span>
                <span class="pulse-dot w-3 h-3 bg-purple-600 rounded-full" style="animation-delay: 0.2s;"></span>
                <span class="pulse-dot w-3 h-3 bg-purple-600 rounded-full" style="animation-delay: 0.4s;"></span>
            </div>
            
            <button 
                onclick="cancelMatching()"
                class="text-gray-500 hover:text-gray-700 font-semibold underline">
                å–æ¶ˆé…å¯¹
            </button>
        </div>
    </div>

    <!-- èŠå¤©é¡µé¢ -->
    <div id="chatPage" class="hidden flex flex-col h-screen">
        <!-- å¤´éƒ¨ -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 shadow-lg p-4">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <div>
                        <h2 class="text-xl font-bold text-white">ä¸é™Œç”ŸäººèŠå¤©ä¸­</h2>
                        <p id="connectionStatus" class="text-xs text-purple-100">
                            âœ“ å·²è¿æ¥
                        </p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button 
                        onclick="nextStranger()"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                        â­ï¸ ä¸‹ä¸€ä½
                    </button>
                    <button 
                        onclick="leaveChat()"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                        ğŸšª ç¦»å¼€
                    </button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒº -->
        <div class="flex-1 overflow-y-auto p-4" id="chatMessages">
            <div class="max-w-4xl mx-auto space-y-4">
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>æ¬¢è¿æ¥åˆ°åŒ¿åèŠå¤©å®¤ï¼è¯·éµå®ˆèŠå¤©è§„åˆ™ï¼Œæ–‡æ˜äº¤æµã€‚</p>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div class="bg-white shadow-lg p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="messageInput" 
                        maxlength="500"
                        placeholder="è¾“å…¥æ¶ˆæ¯... (æœ€å¤š500å­—)"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                        onkeypress="handleKeyPress(event)">
                    <button 
                        onclick="sendMessage()"
                        id="sendButton"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                        å‘é€
                    </button>
                </div>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                    <span id="charCount">0/500</span>
                    <span id="cooldownMessage" class="text-red-500 hidden"></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBtpZAG2oLhM27Ud9dAJZGGkGnuTI3ty8Y",
    authDomain: "chatbox-a5f0c.firebaseapp.com",
    databaseURL: "https://chatbox-a5f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chatbox-a5f0c",
    storageBucket: "chatbox-a5f0c.firebasestorage.app",
    messagingSenderId: "917869044646",
    appId: "1:917869044646:web:ce32809b936e8d54866567",
    measurementId: "G-ZVQPC9CPNB"
  };


        // åˆå§‹åŒ– Firebase
        let database;
        let isFirebaseConnected = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // æµ‹è¯•è¿æ¥
            database.ref('.info/connected').on('value', (snapshot) => {
                isFirebaseConnected = snapshot.val() === true;
                if (isFirebaseConnected) {
                    console.log('âœ… Firebase å·²è¿æ¥');
                } else {
                    console.log('âŒ Firebase è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼');
                }
            });
        } catch (error) {
            console.log('âš ï¸ Firebase æœªé…ç½®ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼');
            isFirebaseConnected = false;
        }

        // ç”¨æˆ·æ•°æ®
        let currentUser = {
            id: null,
            name: null,
            lastMessageTime: 0,
            messageCount: 0,
            partnerId: null
        };

        // é…å¯¹çŠ¶æ€
        let matchingState = {
            isMatching: false,
            matchTimeout: null
        };

        // é˜²æ´—ç‰ˆé…ç½®
        const ANTI_SPAM = {
            MIN_MESSAGE_INTERVAL: 2000, // æœ€å°‘2ç§’æ‰èƒ½å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯
            MAX_MESSAGES_PER_MINUTE: 10, // æ¯åˆ†é’Ÿæœ€å¤š10æ¡æ¶ˆæ¯
            MAX_MESSAGE_LENGTH: 500,
            messageTimestamps: []
        };

        // æ•°å­¦éªŒè¯
        let mathAnswer = 0;

        function generateMathQuestion() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            mathAnswer = num1 + num2;
            document.getElementById('mathQuestion').textContent = `${num1} + ${num2} = ?`;
        }

        function generateUserIdentity() {
            const adjectives = ['å¿«ä¹çš„', 'ç¥ç§˜çš„', 'å‹‡æ•¢çš„', 'èªæ˜çš„', 'å‹å–„çš„', 'é…·ç‚«çš„', 'æ¸©æŸ”çš„', 'æœ‰è¶£çš„'];
            const nouns = ['ç†ŠçŒ«', 'ç‹ç‹¸', 'çŒ«å’ª', 'å…”å­', 'ä¼é¹…', 'æµ·è±š', 'è€ƒæ‹‰', 'æ¾é¼ '];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const num = Math.floor(Math.random() * 1000);
            return `${adj}${noun}${num}`;
        }

        // å¼€å§‹é…å¯¹æµç¨‹
        function startMatching() {
            const userAnswer = parseInt(document.getElementById('mathAnswer').value);
            
            // éªŒè¯ç­”æ¡ˆ
            if (userAnswer !== mathAnswer) {
                document.getElementById('verifyError').classList.remove('hidden');
                generateMathQuestion();
                document.getElementById('mathAnswer').value = '';
                return;
            }

            // ç”Ÿæˆç”¨æˆ·èº«ä»½
            currentUser.id = Date.now();
            currentUser.name = generateUserIdentity();
            
            // è¿›å…¥é…å¯¹é¡µé¢
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById('matchingPage').classList.remove('hidden');
            
            matchingState.isMatching = true;
            
            // æ¨¡æ‹Ÿé…å¯¹ï¼ˆ2-5ç§’ååŒ¹é…æˆåŠŸï¼‰
            const matchDelay = 2000 + Math.random() * 3000;
            matchingState.matchTimeout = setTimeout(() => {
                matchFound();
            }, matchDelay);
        }

        // æ‰¾åˆ°é…å¯¹
        function matchFound() {
            matchingState.isMatching = false;
            currentUser.partnerId = 'stranger_' + Math.floor(Math.random() * 10000);
            
            // è¿›å…¥èŠå¤©é¡µé¢
            document.getElementById('matchingPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');

            // æ¸…ç©ºä¹‹å‰çš„æ¶ˆæ¯
            clearMessages();

            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage('âœ… å·²è¿æ¥åˆ°é™Œç”Ÿäººï¼');
            addSystemMessage('ğŸ’¡ æç¤ºï¼šæ–‡æ˜èŠå¤©ï¼Œå°Šé‡ä»–äºº');

            // æ¨¡æ‹Ÿå¯¹æ–¹æ‰“æ‹›å‘¼
            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addMessage('é™Œç”Ÿäºº', getRandomGreeting(), false);
                }, 1500);
            }, 1000);
        }

        // å–æ¶ˆé…å¯¹
        function cancelMatching() {
            if (matchingState.matchTimeout) {
                clearTimeout(matchingState.matchTimeout);
            }
            matchingState.isMatching = false;
            location.reload();
        }

        // ä¸‹ä¸€ä½ï¼ˆé‡æ–°é…å¯¹ï¼‰
        function nextStranger() {
            if (confirm('ç¡®å®šè¦ç¦»å¼€å½“å‰å¯¹è¯ï¼Œå¯»æ‰¾ä¸‹ä¸€ä½é™Œç”Ÿäººå—ï¼Ÿ')) {
                addSystemMessage('ğŸ”„ é™Œç”Ÿäººå·²ç¦»å¼€ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾æ–°çš„å¯¹è¯å¯¹è±¡...');
                
                // ç¦ç”¨è¾“å…¥
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
                
                setTimeout(() => {
                    // æ¸…ç©ºæ¶ˆæ¯
                    clearMessages();
                    
                    // å¯ç”¨è¾“å…¥
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    
                    // é‡æ–°é…å¯¹
                    matchFound();
                }, 2000);
            }
        }

        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            const messagesDiv = document.getElementById('chatMessages').firstElementChild;
            messagesDiv.innerHTML = '';
        }

        // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages').firstElementChild;
            const typingEl = document.createElement('div');
            typingEl.id = 'typingIndicator';
            typingEl.className = 'chat-message flex justify-start';
            typingEl.innerHTML = `
                <div class="bg-gray-100 rounded-lg px-4 py-2 shadow">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingEl);
            scrollToBottom();
        }

        // éšè—"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const typingEl = document.getElementById('typingIndicator');
            if (typingEl) {
                typingEl.remove();
            }
        }

        // éšæœºé—®å€™è¯­
        function getRandomGreeting() {
            const greetings = [
                'å—¨ï¼ğŸ‘‹',
                'ä½ å¥½å•Šï¼',
                'Hello~',
                'å“ˆå–½ï¼ğŸ˜Š',
                'å—¨å—¨ï¼',
                'Hi there!',
                'ä½ å¥½å‘€~',
                'å¾ˆé«˜å…´è®¤è¯†ä½ ï¼'
            ];
            return greetings[Math.floor(Math.random() * greetings.length)];
        }

        function startChat() {
            const userAnswer = parseInt(document.getElementById('mathAnswer').value);
            
            // éªŒè¯ç­”æ¡ˆ
            if (userAnswer !== mathAnswer) {
                document.getElementById('verifyError').classList.remove('hidden');
                generateMathQuestion();
                document.getElementById('mathAnswer').value = '';
                return;
            }

            // ç”Ÿæˆç”¨æˆ·èº«ä»½
            currentUser.id = Date.now();
            currentUser.name = generateUserIdentity();
            
            document.getElementById('userIdentity').textContent = currentUser.name;
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');

            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            addSystemMessage(`${currentUser.name} åŠ å…¥äº†èŠå¤©å®¤`);

            // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            setTimeout(() => {
                addMessage('ç¥ç§˜çš„ç‹ç‹¸42', 'å¤§å®¶å¥½ï¼ğŸ‘‹', false);
            }, 2000);
        }

        function leaveChat() {
            if (confirm('ç¡®å®šè¦ç¦»å¼€èŠå¤©å®¤å—ï¼Ÿ')) {
                addSystemMessage(`${currentUser.name} ç¦»å¼€äº†èŠå¤©å®¤`);
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        function checkSpamProtection() {
            const now = Date.now();
            
            // æ£€æŸ¥æ¶ˆæ¯å‘é€é—´éš”
            if (now - currentUser.lastMessageTime < ANTI_SPAM.MIN_MESSAGE_INTERVAL) {
                const remaining = Math.ceil((ANTI_SPAM.MIN_MESSAGE_INTERVAL - (now - currentUser.lastMessageTime)) / 1000);
                showCooldown(`è¯·ç­‰å¾… ${remaining} ç§’åå†å‘é€`);
                return false;
            }

            // æ£€æŸ¥æ¯åˆ†é’Ÿæ¶ˆæ¯æ•°é‡
            ANTI_SPAM.messageTimestamps = ANTI_SPAM.messageTimestamps.filter(time => now - time < 60000);
            if (ANTI_SPAM.messageTimestamps.length >= ANTI_SPAM.MAX_MESSAGES_PER_MINUTE) {
                showCooldown('å‘é€å¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                return false;
            }

            return true;
        }

        function showCooldown(message) {
            const cooldownEl = document.getElementById('cooldownMessage');
            cooldownEl.textContent = message;
            cooldownEl.classList.remove('hidden');
            setTimeout(() => {
                cooldownEl.classList.add('hidden');
            }, 3000);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // é˜²æ´—ç‰ˆæ£€æŸ¥
            if (!checkSpamProtection()) return;

            // æ·»åŠ æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºä¸º"ä½ "ï¼‰
            addMessage('ä½ ', message, true);
            
            // æ›´æ–°é˜²æ´—ç‰ˆæ•°æ®
            currentUser.lastMessageTime = Date.now();
            ANTI_SPAM.messageTimestamps.push(Date.now());

            input.value = '';
            updateCharCount();

            // æ¨¡æ‹Ÿé™Œç”Ÿäººå›å¤ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            // 30% å‡ ç‡å¯¹æ–¹æ­£åœ¨è¾“å…¥
            if (Math.random() < 0.3) {
                setTimeout(() => {
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addMessage('é™Œç”Ÿäºº', getRandomResponse(), false);
                    }, 1500 + Math.random() * 2000);
                }, 500);
            } else {
                // ç›´æ¥å›å¤
                setTimeout(() => {
                    addMessage('é™Œç”Ÿäºº', getRandomResponse(), false);
                }, 1000 + Math.random() * 3000);
            }
        }

        // éšæœºå›å¤
        function getRandomResponse() {
            const responses = [
                'å“ˆå“ˆå“ˆğŸ˜‚',
                'æœ‰è¶£ï¼ğŸ˜Š',
                'æˆ‘ä¹Ÿè¿™ä¹ˆæƒ³',
                'è¯´å¾—å¯¹ï¼',
                'çœŸçš„å—ï¼Ÿ',
                'å—¯å—¯',
                'ç„¶åå‘¢ï¼Ÿ',
                'å“‡ï¼',
                'ğŸ‘',
                'å¥½çš„ï¼',
                'æ˜¯å•Š',
                'ç¡®å®',
                'æˆ‘æ‡‚ä½ çš„æ„æ€',
                'æœ‰é“ç†',
                'å‰å®³ï¼',
                'ğŸ˜„',
                'ğŸ¤”',
                'å¤ªæ£’äº†ï¼',
                'ç»§ç»­è¯´~',
                'åŸæ¥å¦‚æ­¤'
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function addMessage(username, message, isCurrentUser) {
            const messagesDiv = document.getElementById('chatMessages').firstElementChild;
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
            
            const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            
            messageEl.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="text-xs ${isCurrentUser ? 'text-right' : 'text-left'} mb-1">
                        <span class="font-semibold ${isCurrentUser ? 'text-indigo-600' : 'text-gray-600'}">${username}</span>
                        <span class="text-gray-400 ml-2">${time}</span>
                    </div>
                    <div class="${isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800'} rounded-lg px-4 py-2 shadow">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(messageEl);
            scrollToBottom();
        }

        function addSystemMessage(message) {
            const messagesDiv = document.getElementById('chatMessages').firstElementChild;
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message text-center';
            messageEl.innerHTML = `
                <div class="inline-block bg-gray-200 text-gray-600 text-sm px-4 py-2 rounded-full">
                    ${escapeHtml(message)}
                </div>
            `;
            messagesDiv.appendChild(messageEl);
            scrollToBottom();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const count = input.value.length;
            document.getElementById('charCount').textContent = `${count}/${ANTI_SPAM.MAX_MESSAGE_LENGTH}`;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            generateMathQuestion();
            document.getElementById('messageInput').addEventListener('input', updateCharCount);
            
            // é˜²æ­¢è¡¨å•è‡ªåŠ¨æäº¤
            document.getElementById('mathAnswer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startChat();
                }
            });
        });

        // é˜²æ­¢é¡µé¢æ„å¤–å…³é—­
        window.addEventListener('beforeunload', function(e) {
            if (currentUser.id && !document.getElementById('chatPage').classList.contains('hidden')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ========================================
        // ğŸ”¥ çœŸå®å¤šäººèŠå¤©åŠŸèƒ½ï¼ˆéœ€é…ç½® Firebaseï¼‰
        // ========================================
        
        let chatRoom = null;
        let messageListener = null;
        let partnerStatusListener = null;
        
        // é‡å†™ startMatching å‡½æ•°ï¼ˆçœŸå®é…å¯¹ç‰ˆæœ¬ï¼‰
        const originalStartMatching = startMatching;
        startMatching = function() {
            const userAnswer = parseInt(document.getElementById('mathAnswer').value);
            
            if (userAnswer !== mathAnswer) {
                document.getElementById('verifyError').classList.remove('hidden');
                generateMathQuestion();
                document.getElementById('mathAnswer').value = '';
                return;
            }

            currentUser.id = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            currentUser.name = generateUserIdentity();
            
            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById('matchingPage').classList.remove('hidden');
            
            matchingState.isMatching = true;
            
            // å¦‚æœ Firebase å·²è¿æ¥ï¼Œä½¿ç”¨çœŸå®é…å¯¹
            if (isFirebaseConnected) {
                findMatch();
            } else {
                // å¦åˆ™ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼
                const matchDelay = 2000 + Math.random() * 3000;
                matchingState.matchTimeout = setTimeout(() => {
                    matchFound();
                }, matchDelay);
            }
        };

        // å¯»æ‰¾é…å¯¹
        function findMatch() {
            const waitingRef = database.ref('waiting');
            
            // æŸ¥æ‰¾ç­‰å¾…ä¸­çš„ç”¨æˆ·
            waitingRef.once('value', (snapshot) => {
                const waitingUsers = snapshot.val();
                let foundPartner = false;
                
                if (waitingUsers) {
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…çš„ç”¨æˆ·
                    for (let userId in waitingUsers) {
                        if (userId !== currentUser.id) {
                            // æ‰¾åˆ°é…å¯¹å¯¹è±¡
                            foundPartner = true;
                            const partnerId = userId;
                            
                            // åˆ›å»ºèŠå¤©å®¤
                            createChatRoom(currentUser.id, partnerId);
                            
                            // ä»ç­‰å¾…åˆ—è¡¨ä¸­ç§»é™¤é…å¯¹å¯¹è±¡
                            database.ref('waiting/' + partnerId).remove();
                            
                            break;
                        }
                    }
                }
                
                if (!foundPartner) {
                    // æ²¡æœ‰æ‰¾åˆ°é…å¯¹ï¼ŒåŠ å…¥ç­‰å¾…åˆ—è¡¨
                    database.ref('waiting/' + currentUser.id).set({
                        id: currentUser.id,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // ç›‘å¬æ˜¯å¦æœ‰äººé…å¯¹
                    listenForMatch();
                }
            });
        }

        // ç›‘å¬é…å¯¹
        function listenForMatch() {
            const userRef = database.ref('waiting/' + currentUser.id);
            
            // å®šæœŸæ£€æŸ¥æ˜¯å¦è¢«é…å¯¹
            const checkInterval = setInterval(() => {
                userRef.once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        // å·²è¢«é…å¯¹ï¼Œæ¸…é™¤ç­‰å¾…ç›‘å¬
                        clearInterval(checkInterval);
                        
                        // æŸ¥æ‰¾èŠå¤©å®¤
                        findChatRoom();
                    }
                });
            }, 1000);
            
            // è¶…æ—¶åä½¿ç”¨æ¼”ç¤ºæ¨¡å¼
            setTimeout(() => {
                clearInterval(checkInterval);
                userRef.once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        // ä»åœ¨ç­‰å¾…ï¼Œç§»é™¤å¹¶ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼
                        userRef.remove();
                        matchFound(); // æ¼”ç¤ºæ¨¡å¼
                    }
                });
            }, 15000); // 15ç§’åè¶…æ—¶
        }

        // æŸ¥æ‰¾èŠå¤©å®¤
        function findChatRoom() {
            database.ref('rooms').orderByChild('user1').equalTo(currentUser.id).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const rooms = snapshot.val();
                    const roomId = Object.keys(rooms)[0];
                    joinChatRoom(roomId);
                } else {
                    database.ref('rooms').orderByChild('user2').equalTo(currentUser.id).once('value', (snapshot2) => {
                        if (snapshot2.exists()) {
                            const rooms = snapshot2.val();
                            const roomId = Object.keys(rooms)[0];
                            joinChatRoom(roomId);
                        }
                    });
                }
            });
        }

        // åˆ›å»ºèŠå¤©å®¤
        function createChatRoom(user1Id, user2Id) {
            const roomId = 'room_' + Date.now();
            chatRoom = roomId;
            
            database.ref('rooms/' + roomId).set({
                user1: user1Id,
                user2: user2Id,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                active: true
            });
            
            joinChatRoom(roomId);
        }

        // åŠ å…¥èŠå¤©å®¤
        function joinChatRoom(roomId) {
            chatRoom = roomId;
            matchingState.isMatching = false;
            
            // è¿›å…¥èŠå¤©é¡µé¢
            document.getElementById('matchingPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            
            clearMessages();
            addSystemMessage('âœ… å·²è¿æ¥åˆ°é™Œç”Ÿäººï¼');
            addSystemMessage('ğŸ’¡ æç¤ºï¼šæ–‡æ˜èŠå¤©ï¼Œå°Šé‡ä»–äºº');
            
            // ç›‘å¬æ¶ˆæ¯
            listenForMessages();
            
            // ç›‘å¬å¯¹æ–¹çŠ¶æ€
            listenForPartnerStatus();
        }

        // ç›‘å¬æ¶ˆæ¯
        function listenForMessages() {
            if (!chatRoom) return;
            
            const messagesRef = database.ref('messages/' + chatRoom);
            
            messageListener = messagesRef.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                
                if (msg.senderId !== currentUser.id) {
                    // å¯¹æ–¹çš„æ¶ˆæ¯
                    hideTypingIndicator();
                    addMessage('é™Œç”Ÿäºº', msg.text, false);
                }
            });
        }

        // ç›‘å¬å¯¹æ–¹çŠ¶æ€
        function listenForPartnerStatus() {
            if (!chatRoom) return;
            
            const roomRef = database.ref('rooms/' + chatRoom);
            
            partnerStatusListener = roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                
                if (!room || !room.active) {
                    // èŠå¤©å®¤å·²å…³é—­
                    addSystemMessage('âš ï¸ é™Œç”Ÿäººå·²ç¦»å¼€èŠå¤©');
                    setTimeout(() => {
                        nextStranger();
                    }, 2000);
                }
            });
        }

        // é‡å†™ sendMessageï¼ˆçœŸå®å‘é€ç‰ˆæœ¬ï¼‰
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;
            if (!checkSpamProtection()) return;

            // æ·»åŠ åˆ°ç•Œé¢
            addMessage('ä½ ', message, true);
            
            // å¦‚æœ Firebase å·²è¿æ¥ä¸”åœ¨èŠå¤©å®¤ä¸­
            if (isFirebaseConnected && chatRoom) {
                // å‘é€åˆ° Firebase
                database.ref('messages/' + chatRoom).push({
                    senderId: currentUser.id,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // æ¼”ç¤ºæ¨¡å¼çš„è‡ªåŠ¨å›å¤
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addMessage('é™Œç”Ÿäºº', getRandomResponse(), false);
                        }, 1500 + Math.random() * 2000);
                    }, 500);
                } else {
                    setTimeout(() => {
                        addMessage('é™Œç”Ÿäºº', getRandomResponse(), false);
                    }, 1000 + Math.random() * 3000);
                }
            }
            
            currentUser.lastMessageTime = Date.now();
            ANTI_SPAM.messageTimestamps.push(Date.now());
            input.value = '';
            updateCharCount();
        };

        // é‡å†™ nextStrangerï¼ˆçœŸå®åˆ‡æ¢ç‰ˆæœ¬ï¼‰
        const originalNextStranger = nextStranger;
        nextStranger = function() {
            if (!confirm('ç¡®å®šè¦ç¦»å¼€å½“å‰å¯¹è¯ï¼Œå¯»æ‰¾ä¸‹ä¸€ä½é™Œç”Ÿäººå—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…ç†å½“å‰èŠå¤©å®¤
            if (isFirebaseConnected && chatRoom) {
                // ç§»é™¤ç›‘å¬
                if (messageListener) {
                    database.ref('messages/' + chatRoom).off('child_added', messageListener);
                }
                if (partnerStatusListener) {
                    database.ref('rooms/' + chatRoom).off('value', partnerStatusListener);
                }
                
                // å…³é—­èŠå¤©å®¤
                database.ref('rooms/' + chatRoom).update({ active: false });
                chatRoom = null;
            }
            
            addSystemMessage('ğŸ”„ æ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾æ–°çš„å¯¹è¯å¯¹è±¡...');
            
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            setTimeout(() => {
                clearMessages();
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                // é‡æ–°é…å¯¹
                if (isFirebaseConnected) {
                    document.getElementById('chatPage').classList.add('hidden');
                    document.getElementById('matchingPage').classList.remove('hidden');
                    findMatch();
                } else {
                    matchFound();
                }
            }, 2000);
        };

        // é‡å†™ leaveChatï¼ˆæ¸…ç†èµ„æºç‰ˆæœ¬ï¼‰
        const originalLeaveChat = leaveChat;
        leaveChat = function() {
            if (!confirm('ç¡®å®šè¦ç¦»å¼€èŠå¤©å®¤å—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…ç† Firebase èµ„æº
            if (isFirebaseConnected && chatRoom) {
                if (messageListener) {
                    database.ref('messages/' + chatRoom).off('child_added', messageListener);
                }
                if (partnerStatusListener) {
                    database.ref('rooms/' + chatRoom).off('value', partnerStatusListener);
                }
                database.ref('rooms/' + chatRoom).update({ active: false });
            }
            
            // ä»ç­‰å¾…åˆ—è¡¨ä¸­ç§»é™¤
            if (isFirebaseConnected && currentUser.id) {
                database.ref('waiting/' + currentUser.id).remove();
            }
            
            location.reload();
        };

        // é‡å†™ cancelMatchingï¼ˆæ¸…ç†ç­‰å¾…ç‰ˆæœ¬ï¼‰
        const originalCancelMatching = cancelMatching;
        cancelMatching = function() {
            if (matchingState.matchTimeout) {
                clearTimeout(matchingState.matchTimeout);
            }
            
            // ä»ç­‰å¾…åˆ—è¡¨ä¸­ç§»é™¤
            if (isFirebaseConnected && currentUser.id) {
                database.ref('waiting/' + currentUser.id).remove();
            }
            
            matchingState.isMatching = false;
            location.reload();
        };

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('unload', function() {
            if (isFirebaseConnected) {
                if (chatRoom) {
                    database.ref('rooms/' + chatRoom).update({ active: false });
                }
                if (currentUser.id) {
                    database.ref('waiting/' + currentUser.id).remove();
                }
            }
        });
    </script>
</body>
</html>